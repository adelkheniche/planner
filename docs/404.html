```html
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning (sept. 2025 → fév. 2026)</title>

    <!-- Tailwind CDN (prototypage) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <meta name="color-scheme" content="light" />
    <style>
      html{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
/* ============= App ============= */
const { useEffect, useMemo, useRef, useState } = React;

/* ---------- Config Supabase ---------- */
const SUPABASE_URL      = "https://kadoikpkjmkchabvnuqs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthZG9pa3Bram1rY2hhYnZudXFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzEwNDIsImV4cCI6MjA3MDkwNzA0Mn0.q28StZ8nsrbck2Xx6xBCfpgdfLotxne3cyWc6-o_FZM";
const DOC_SLUG          = "main";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- Dates / utils ---------- */
const WEEK_STARTS_ON = 1;
const MS_DAY = 24 * 60 * 60 * 1000;

/* Hauteur unique des lignes (contrôle espacement) */
const ROW_H   = 24; // ← ajustez ici (22–28)
const ROW_GAP = 2;

function startOfWeek(d, w=WEEK_STARTS_ON){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=x.getDay(); const diff=(day-w+7)%7; x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; }
function endOfWeek(d, w=WEEK_STARTS_ON){ const s=startOfWeek(d,w); const e=new Date(s.getTime()+MS_DAY*6); e.setHours(23,59,59,999); return e; }
function clampDate(d,minD,maxD){ if(d<minD) return new Date(minD); if(d>maxD) return new Date(maxD); return d; }
function toISODate(d){ const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${yyyy}-${mm}-${dd}`; }
function addWeeksISO(iso,n,minD,maxD){ const d=new Date(iso); d.setDate(d.getDate()+7*n); return toISODate(clampDate(d,minD,maxD)); }
function getISOWeek(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil(((d-yearStart)/MS_DAY+1)/7); }

const fmtMonthYear = new Intl.DateTimeFormat("fr-FR",{month:"long",year:"numeric"});
const fmtDM = new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short"});

const TIMELINE_START = startOfWeek(new Date(2025, 8, 1));
const TIMELINE_END   = endOfWeek(new Date(2026, 1, 28));

function eachWeekOfInterval(start,end){
  const weeks=[]; let cur=startOfWeek(start); const endW=startOfWeek(end);
  while(cur<=endW){ weeks.push(new Date(cur)); const next=new Date(cur); next.setDate(next.getDate()+7); cur=startOfWeek(next); if(weeks.length>400) break; }
  return weeks;
}

/* ---------- Cache local ---------- */
const LS_KEY = "gantt-sept2025-fev2026";
function loadState(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null; }catch{ return null; } }
function saveState(state){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{} }

/* ---------- Transfert par URL (#s=base64) ---------- */
function b64Encode(str){ try{ return btoa(unescape(encodeURIComponent(str))); }catch{ return btoa(str);} }
function b64Decode(str){ try{ return decodeURIComponent(escape(atob(str))); }catch{ return atob(str);} }
(function importFromHash(){
  try{
    const h=location.hash;
    if(h && h.startsWith("#s=")){
      const s=JSON.parse(b64Decode(h.slice(3)));
      if(s) localStorage.setItem(LS_KEY, JSON.stringify({categories:s.categories||[],tasks:s.tasks||[]}));
      history.replaceState(null,"", location.pathname+location.search);
    }
  }catch(e){ console.warn("State-from-hash failed",e); }
})();

/* ---------- Error boundary ---------- */
class ErrorBoundary extends React.Component{
  constructor(p){ super(p); this.state={error:null}; }
  static getDerivedStateFromError(e){ return {error:e}; }
  render(){
    if(this.state.error){
      return <div style={{padding:16}} className="mx-auto max-w-[900px] rounded-xl border border-red-200 bg-red-50 text-red-800">
        <div className="font-semibold">Une erreur est survenue.</div>
        <div className="text-sm mt-1">{String(this.state.error?.message || this.state.error)}</div>
      </div>;
    }
    return this.props.children;
  }
}

/* ---------- App ---------- */
function PlannerApp(){
  const weeks = useMemo(()=>eachWeekOfInterval(TIMELINE_START,TIMELINE_END),[]);
  const colWidthPx = 44;
  const totalWidthPx = weeks.length * colWidthPx;

  const monthSegments = useMemo(()=>{
    if(weeks.length===0) return [];
    const segs=[]; let currentLabel=fmtMonthYear.format(new Date(weeks[0].getTime()+MS_DAY*3)); let span=0;
    for(let i=0;i<weeks.length;i++){ const label=fmtMonthYear.format(new Date(weeks[i].getTime()+MS_DAY*3)); if(label===currentLabel) span++; else { segs.push({label:currentLabel,span}); currentLabel=label; span=1; } }
    segs.push({label:currentLabel,span}); return segs;
  },[weeks]);

  /* State principal */
  const initial = loadState();
  const [categories,setCategories] = useState(initial?.categories || []);
  const [tasks,setTasks] = useState((initial?.tasks || []).map((t,i)=>({
    ...t,
    row: typeof t.row === "number" ? t.row : i,
    subtasks: Array.isArray(t.subtasks) ? t.subtasks : [], // tableau d'IDs de tâches
    expanded: !!t.expanded
  })));

  const [sync,setSync]=useState({status:'idle',ts:null,error:null});
  const [panelOpen,setPanelOpen]=useState(false);
  const [showTests,setShowTests]=useState(false);

  /* Éditeur de sous-frise (modal) */
  const [subEditor,setSubEditor] = useState({
    parentId: null, // id de la tâche parente
    drag: null      // { taskId, x, y } pour le glisser depuis la bibliothèque
  });
  const dropRef = useRef(null); // zone de drop de la sous-frise

  function openSubEditor(parentId){ setSubEditor({ parentId, drag:null }); }
  function closeSubEditor(){ setSubEditor({ parentId:null, drag:null }); }

  /* Supabase: chargement */
  useEffect(()=>{
    (async ()=>{
      setSync({status:'loading',ts:null,error:null});
      const { data, error } = await supabase.from("planner_state").select("data").eq("slug", DOC_SLUG).maybeSingle();
      if(error){ setSync({status:'error',ts:null,error:error.message}); return; }
      if(data?.data){
        const s=data.data;
        setCategories(Array.isArray(s.categories)? s.categories:[]);
        setTasks(Array.isArray(s.tasks)? s.tasks.map((t,i)=>({
          ...t,
          row: typeof t.row === "number" ? t.row : i,
          subtasks: Array.isArray(t.subtasks) ? t.subtasks : [],
          expanded: !!t.expanded
        })) : []);
        setSync({status:'ok',ts:new Date().toISOString(),error:null});
      }else{
        await supabase.from("planner_state").insert({slug:DOC_SLUG,data:{categories,tasks},updated_at:new Date().toISOString()});
        setSync({status:'ok',ts:new Date().toISOString(),error:null});
      }
    })();
  // eslint-disable-next-line react-hooks/exhaustive-deps
  },[]);

  /* Persistance locale + Supabase (debounce) */
  useEffect(()=>{ saveState({categories,tasks}); },[categories,tasks]);
  useEffect(()=>{
    const payload={categories,tasks};
    const t=setTimeout(async ()=>{
      setSync(s=>({...s,status:'saving'}));
      const { error } = await supabase.from("planner_state").upsert({slug:DOC_SLUG,data:payload,updated_at:new Date().toISOString()});
      if(error) setSync({status:'error',ts:null,error:error.message});
      else     setSync({status:'ok',ts:new Date().toISOString(),error:null});
    },600);
    return ()=>clearTimeout(t);
  },[categories,tasks]);

  /* Helpers */
  function weekIndexOf(date){ const s=startOfWeek(clampDate(date,TIMELINE_START,TIMELINE_END)); const idx=Math.round((s.getTime()-TIMELINE_START.getTime())/(MS_DAY*7)); return Math.max(0,Math.min(weeks.length-1,idx)); }
  function taskToGrid(task){ const start=new Date(task.startISO); const end=new Date(task.endISO); const startIdx=weekIndexOf(start); const endIdx=weekIndexOf(end); const span=Math.max(1,endIdx-startIdx+1); return {startIdx,span}; }

  const enabledCategoryIds = useMemo(()=> new Set(categories.filter(c=>c.enabled!==false).map(c=>c.id)),[categories]);

  /* APLAT pour affichage principal (insère les sous-tâches si expanded) */
  const tasksToShow = useMemo(()=>{
    const filtered = !categories.length
      ? tasks
      : tasks.filter(t=>!t.categoryId || enabledCategoryIds.has(t.categoryId));

    const sorted = filtered.slice().sort((a,b)=> (a.row??0) - (b.row??0));

    const res=[]; let offset=0;
    for(const t of sorted){
      const baseRow=(t.row??0)+offset;
      res.push({...t,row:baseRow});
      if(t.expanded && Array.isArray(t.subtasks)){
        t.subtasks.forEach((childId,idx)=>{
          const child = tasks.find(x=>x.id===childId);
          if(child){
            res.push({...child,row:baseRow+idx+1,parentId:t.id}); // clone visuel
          }
        });
        offset += t.subtasks.length;
      }
    }
    return res;
  },[tasks,categories,enabledCategoryIds]);

  /* CRUD catégories/tâches */
  function getOrCreateCategoryByName(name,colorOverride){
    let c=categories.find(x=>x.name===name); if(c) return c;
    const palette=["#2563eb","#16a34a","#ea580c","#9333ea","#0ea5e9","#ef4444","#22c55e","#f59e0b","#64748b","#d946ef","#14b8a6","#a16207"];
    const color=colorOverride || palette[categories.length%palette.length];
    c={ id:`c-${Date.now()}-${Math.random().toString(36).slice(2,6)}`, name, color, enabled:true };
    setCategories(prev=>[...prev,c]); return c;
  }
  const [newTask,setNewTask]=useState({
    title:"",
    startISO:toISODate(TIMELINE_START),
    endISO:toISODate(new Date(TIMELINE_START.getTime()+MS_DAY*7)),
    range:`${toISODate(TIMELINE_START)} → ${toISODate(new Date(TIMELINE_START.getTime()+MS_DAY*7))}`,
    color:"#2563eb",
    categoryId:"",
    newCategoryName:""
  });
  function parseDateRangeFromText(text){
    if(typeof text!=="string") return null; const raw=text.trim(); if(!raw) return null;
    let sep="→", idx=raw.indexOf("→"); if(idx<0){ for(const c of [" — "," – "," to "," au "," -> "," - "]){ const j=raw.indexOf(c); if(j>=0){ sep=c; idx=j; break; } } }
    if(idx<0) return null; const a=raw.slice(0,idx).trim(); const b=raw.slice(idx+sep.length).trim();
    const isISO=x=>x && x.length===10 && x[4]==='-' && x[7]==='-' && !isNaN(Date.parse(x));
    if(!isISO(a)||!isISO(b)) return null;
    const s=clampDate(new Date(a),TIMELINE_START,TIMELINE_END); const e=clampDate(new Date(b),TIMELINE_START,TIMELINE_END);
    return { startISO:toISODate(s), endISO:toISODate(e) };
  }
  function addTask(e){
    e.preventDefault();
    const s=new Date(newTask.startISO), eDate=new Date(newTask.endISO);
    if(s>eDate){ alert("La date de début doit précéder la date de fin."); return; }
    let chosenCat=categories.find(c=>c.id===newTask.categoryId);
    if(!chosenCat && newTask.newCategoryName.trim()){
      const existing=categories.find(c=>c.name.toLowerCase()===newTask.newCategoryName.trim().toLowerCase());
      chosenCat = existing || getOrCreateCategoryByName(newTask.newCategoryName.trim(),newTask.color);
    }
    const color=chosenCat?chosenCat.color:newTask.color;
    const t={ id:`t-${Date.now()}`, title:newTask.title || (chosenCat?chosenCat.name:"Sans titre"),
      startISO:toISODate(clampDate(s,TIMELINE_START,TIMELINE_END)),
      endISO:toISODate(clampDate(eDate,TIMELINE_START,TIMELINE_END)),
      color, categoryId:chosenCat?.id, row:tasks.length, notes:[], subtasks:[], expanded:false };
    setTasks(prev=>[...prev,t]);
  }
  function removeTask(id){ setTasks(prev=>prev.filter(t=>t.id!==id)); }
  function removeCategory(id){ setTasks(prev=>prev.filter(t=>t.categoryId!==id)); setCategories(prev=>prev.filter(c=>c.id!==id)); }
  function toggleCategory(id){ setCategories(prev=>prev.map(c=> c.id===id?{...c,enabled:!(c.enabled!==false)}:c)); }
  function updateCategoryColor(id,newColor){ setCategories(prev=>prev.map(c=> c.id===id?{...c,color:newColor}:c)); setTasks(prev=>prev.map(t=> t.categoryId===id?{...t,color:newColor}:t)); }
  function resetAll(){ try{localStorage.removeItem(LS_KEY);}catch{} setPanelOpen(false); setCategories([]); setTasks([]); }

  function changeRow(id,delta){ setTasks(prev=> prev.map(t=> t.id===id ? {...t, row:Math.max(0,(t.row??0)+delta)} : t)); }
  function toggleExpanded(id){ setTasks(prev=> prev.map(t=> t.id===id ? {...t, expanded: !t.expanded} : t)); }

  /* Sous-tâches (stockées comme IDs) */
  function addSubtaskAt(parentId, childId, atIndex=null){
    if(parentId===childId) return;
    setTasks(prev=> prev.map(t=>{
      if(t.id!==parentId) return t;
      const cur = Array.isArray(t.subtasks)? [...t.subtasks] : [];
      if(cur.includes(childId)) return {...t, expanded:true};
      const idx = (atIndex==null) ? cur.length : Math.max(0, Math.min(atIndex, cur.length));
      cur.splice(idx, 0, childId);
      return {...t, subtasks:cur, expanded:true};
    }));
  }
  function removeSubtask(parentId, childId){
    setTasks(prev=> prev.map(t=> t.id===parentId ? {...t, subtasks:(t.subtasks||[]).filter(id=>id!==childId)} : t));
  }
  function moveSubtask(parentId, childId, dir){
    setTasks(prev=> prev.map(t=>{
      if(t.id!==parentId) return t;
      const cur=[...(t.subtasks||[])];
      const i=cur.indexOf(childId); if(i<0) return t;
      const j=Math.max(0, Math.min(cur.length-1, i+(dir<0?-1:1)));
      [cur[i],cur[j]]=[cur[j],cur[i]];
      return {...t, subtasks:cur};
    }));
  }

  /* Drag & Drop principal (déplacement/résize) */
  const [drag,setDrag]=useState(null);
  useEffect(()=>{
    if(!drag) return;
    function onMove(e){ setDrag(d => d ? {...d, dx:e.clientX - d.startX, dy:e.clientY - (d.startY||0)} : d); }
    function onUp(){
      setTasks(prev=>{
        const d=drag; if(!d) return prev;
        const idx=prev.findIndex(t=>t.id===d.taskId); if(idx<0) return prev;
        const t=prev[idx];
        const deltaWeeks=Math.round((d.dx||0)/colWidthPx);
        const deltaRows = (d.type==='move') ? Math.round((d.dy||0)/ROW_H) : 0;
        if(deltaWeeks===0 && deltaRows===0 && d.type!=='left' && d.type!=='right') return prev.slice();

        const copy=prev.slice();
        if(d.type==='move'){
          const ns=addWeeksISO(t.startISO,deltaWeeks,TIMELINE_START,TIMELINE_END);
          const ne=addWeeksISO(t.endISO,deltaWeeks,TIMELINE_START,TIMELINE_END);
          copy[idx]={...t,startISO:ns,endISO:ne,row:Math.max(0,(t.row??0)+deltaRows)};
        }
        if(d.type==='right'){
          const ne=addWeeksISO(t.endISO,deltaWeeks,TIMELINE_START,TIMELINE_END);
          copy[idx]={...t,endISO:ne};
        }
        if(d.type==='left'){
          const ns=addWeeksISO(t.startISO,deltaWeeks,TIMELINE_START,TIMELINE_END);
          copy[idx]={...t,startISO:ns};
        }
        return copy;
      });
      setDrag(null);
    }
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',onUp);
    return ()=>{ window.removeEventListener('pointermove',onMove); window.removeEventListener('pointerup',onUp); };
  },[drag]);

  /* Drag depuis la bibliothèque → sous-frise */
  useEffect(()=>{
    if(!subEditor.drag) return;
    function onMove(e){ setSubEditor(s=>({...s, drag:{...s.drag, x:e.clientX, y:e.clientY}})); }
    function onUp(e){
      const d=subEditor.drag;
      const dropEl = dropRef.current;
      if(d && dropEl){
        const rect = dropEl.getBoundingClientRect();
        if(d.x>=rect.left && d.x<=rect.right && d.y>=rect.top && d.y<=rect.bottom){
          const relY = d.y - rect.top;
          const rowIdx = Math.max(0, Math.floor(relY / ROW_H));
          addSubtaskAt(subEditor.parentId, d.taskId, rowIdx);
        }
      }
      setSubEditor(s=>({...s, drag:null}));
    }
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',onUp);
    return ()=>{ window.removeEventListener('pointermove',onMove); window.removeEventListener('pointerup',onUp); };
  },[subEditor.drag]);

  /* UI */
  return (
    <ErrorBoundary>
      {/* Panneau latéral (options) */}
      {panelOpen && (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/20" onClick={()=>setPanelOpen(false)} />
          <aside className="absolute left-0 top-0 h-full w-[380px] max-w-[90vw] overflow-y-auto border-r border-slate-200 bg-white shadow-xl" onClick={e=>e.stopPropagation()}>
            <div className="sticky top-0 z-10 flex items-center justify-between border-b border-slate-200 bg-white px-4 py-3">
              <div className="font-medium">Planificateur</div>
              <div className="flex items-center gap-2">
                <button onClick={()=>setShowTests(v=>!v)} className="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50">{showTests ? 'Tests: ON' : 'Tests: OFF'}</button>
                <button onClick={()=>setPanelOpen(false)} className="rounded-full border border-slate-300 bg-white px-2 py-1 text-sm text-slate-700 hover:bg-slate-50">✕</button>
              </div>
            </div>

            <div className="p-4 space-y-3">
              <button onClick={resetAll} className="rounded-lg border border-red-300 bg-white px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-50">Réinitialiser tout</button>
              <span className="text-xs rounded-full border px-2 py-1 text-slate-700">Synchro: {sync.status}{sync.ts?` · ${new Date(sync.ts).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`:''}</span>

              <form onSubmit={addTask} className="rounded-xl border border-slate-200 bg-white p-4 shadow-sm space-y-3">
                <h2 className="text-sm font-medium text-slate-700">Ajouter une ligne</h2>
                <label className="text-sm block">Intitulé
                  <input type="text" value={newTask.title} onChange={(e)=>setNewTask(s=>({...s,title:e.target.value}))} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" />
                </label>
                <label className="text-sm block">Plage de dates
                  <input type="text" value={newTask.range} onChange={(e)=>{ const v=e.target.value; setNewTask(s=>{ const p=parseDateRangeFromText(v); return p ? {...s,range:v,startISO:p.startISO,endISO:p.endISO} : {...s,range:v}; }); }} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" placeholder="2025-09-06 → 2025-09-22" />
                </label>
                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm">Catégorie
                    <select value={newTask.categoryId} onChange={(e)=>setNewTask(s=>({...s,categoryId:e.target.value}))} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
                      <option value="">— Aucune —</option>
                      {categories.map(c=>(<option key={c.id} value={c.id}>{c.name}</option>))}
                    </select>
                  </label>
                  <label className="text-sm">Couleur (si pas de catégorie)
                    <input type="color" value={newTask.color} onChange={(e)=>setNewTask(s=>({...s,color:e.target.value}))} className="mt-1 h-10 w-full cursor-pointer rounded-lg border border-slate-300" />
                  </label>
                </div>
                <label className="text-sm block">Nom nouvelle catégorie
                  <input type="text" value={newTask.newCategoryName} onChange={(e)=>setNewTask(s=>({...s,newCategoryName:e.target.value}))} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" />
                </label>
                <button type="submit" className="w-full rounded-xl bg-slate-900 px-3 py-2 text-sm font-medium text-white hover:bg-slate-800">Ajouter</button>
              </form>
            </div>
          </aside>
        </div>
      )}

      {/* Modal éditeur de sous-frise */}
      {subEditor.parentId && (
        <div className="fixed inset-0 z-40">
          <div className="absolute inset-0 bg-black/40" onClick={closeSubEditor}></div>
          <div className="absolute left-1/2 top-1/2 w-[min(1200px,95vw)] max-h-[90vh] -translate-x-1/2 -translate-y-1/2 overflow-hidden rounded-2xl bg-white shadow-2xl">
            {/* Header */}
            <div className="flex items-center gap-2 border-b border-slate-200 px-4 py-3">
              {(() => {
                const p = tasks.find(t=>t.id===subEditor.parentId);
                return (
                  <>
                    <div className="h-3 w-3 rounded-full" style={{backgroundColor:p?.color || '#334155'}}></div>
                    <div className="font-medium truncate">{p?.title || "Tâche"}</div>
                    <button onClick={()=>toggleExpanded(subEditor.parentId)} className="ml-2 rounded border border-slate-300 bg-white px-2 py-1 text-xs hover:bg-slate-50">
                      {p?.expanded ? "Masquer dans la frise principale" : "Afficher dans la frise principale"}
                    </button>
                    <button onClick={()=>setTasks(prev=>prev.map(t=> t.id===subEditor.parentId?{...t,subtasks:[]}:t))} className="ml-2 rounded border border-slate-300 bg-white px-2 py-1 text-xs hover:bg-slate-50">Vider</button>
                    <div className="ml-auto"></div>
                    <button onClick={closeSubEditor} className="rounded-full border border-slate-300 bg-white px-2 py-1 text-sm text-slate-700 hover:bg-slate-50">✕</button>
                  </>
                );
              })()}
            </div>

            {/* Bibliothèque + sous-frise */}
            <div className="grid grid-rows-[auto,1fr] gap-3 p-3">
              {/* Bibliothèque (toutes les autres tâches → draggable) */}
              <div className="flex items-center gap-2 overflow-x-auto pb-1">
                {tasks.filter(t=>t.id!==subEditor.parentId).map(t=>(
                  <button
                    key={t.id}
                    onPointerDown={(e)=> setSubEditor(s=>({...s, drag:{taskId:t.id, x:e.clientX, y:e.clientY}}))}
                    className="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-2 py-1 text-xs shadow-sm"
                    title="Glissez dans la sous-frise pour l'ajouter"
                  >
                    <span className="h-2 w-2 rounded-full" style={{backgroundColor:t.color}}></span>
                    <span className="truncate max-w-[220px]">{t.title}</span>
                  </button>
                ))}
              </div>

              {/* Sous-frise du parent */}
              <div className="overflow-auto rounded-xl border border-slate-200">
                <div style={{width: totalWidthPx}}>
                  {/* En-tête semaines (sticky) */}
                  <div className="sticky top-0 z-10 border-b border-slate-200 bg-white/90">
                    <div style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                      {monthSegments.map((m,i)=>(
                        <div key={i} className="flex items-center justify-center border-r border-slate-100 px-2 py-2 text-[11px] font-semibold uppercase tracking-wide text-slate-600" style={{gridColumn:`span ${m.span} / span ${m.span}`}}>{m.label}</div>
                      ))}
                    </div>
                    <div className="border-t border-slate-100" style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                      {weeks.map((w,i)=>(
                        <div key={i} className="flex items-center justify-center border-r border-slate-100 px-1 py-1 text-[10px] text-slate-500" title={`${fmtDM.format(w)} → ${fmtDM.format(new Date(w.getTime()+MS_DAY*6))}`}>
                          S{String(getISOWeek(w)).padStart(2,'0')}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Corps (zone droppable) */}
                  <div ref={dropRef}>
                    {(() => {
                      const parent = tasks.find(t=>t.id===subEditor.parentId);
                      const list = (parent?.subtasks || []);
                      const rows = Math.max(1, list.length);
                      return Array.from({length:rows},(_,row)=>row).map(row=>{
                        return (
                          <div key={row} className="relative border-b border-slate-100" style={{height:ROW_H}}>
                            {/* grille */}
                            <div style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`, height:'100%'}}>
                              {weeks.map((_,i)=><div key={i} className={(i%2===0?"border-slate-50":"border-slate-100")+" border-r"} />)}
                            </div>
                            {/* barre (si existe) */}
                            {list[row] && (()=> {
                              const child = tasks.find(t=>t.id===list[row]);
                              if(!child) return null;
                              const {startIdx,span} = taskToGrid(child);
                              const leftPx = startIdx * colWidthPx;
                              const widthPx= span     * colWidthPx;
                              const isNarrow = widthPx < 64;
                              return (
                                <div className="absolute inset-x-0" style={{top:0,height:ROW_H}}>
                                  <div className="absolute rounded-lg shadow-sm flex items-center gap-1 pl-1 pr-2 text-[11px] text-slate-700"
                                       style={{left:leftPx,width:widthPx, top:ROW_GAP/2, height:ROW_H-ROW_GAP, backgroundColor:child.color}}>
                                    {!isNarrow && <span className="inline-block h-2 w-2 rounded" style={{backgroundColor:child.color}}/>}
                                    <span className="truncate min-w-0 font-medium">{child.title}</span>
                                    <div className="ml-auto flex items-center gap-1">
                                      <button onClick={()=>moveSubtask(subEditor.parentId, child.id, -1)} className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" title="Monter">↑</button>
                                      <button onClick={()=>moveSubtask(subEditor.parentId, child.id, +1)} className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" title="Descendre">↓</button>
                                      <button onClick={()=>removeSubtask(subEditor.parentId, child.id)} className="rounded border border-red-200 bg-white px-1 text-[10px] text-red-700 hover:bg-red-50" title="Retirer">–</button>
                                    </div>
                                  </div>
                                </div>
                              );
                            })()}
                          </div>
                        );
                      });
                    })()}
                  </div>
                </div>
              </div>
            </div>

            {/* Fantôme de drag (depuis la bibliothèque) */}
            {subEditor.drag && (
              <div className="pointer-events-none fixed z-50 rounded-full border border-slate-300 bg-white px-2 py-1 text-xs shadow"
                   style={{left:subEditor.drag.x+8, top:subEditor.drag.y+8}}>
                {(() => {
                  const t = tasks.find(x=>x.id===subEditor.drag.taskId);
                  return (<span className="inline-flex items-center gap-2">
                    <span className="h-2 w-2 rounded-full" style={{background:t?.color||'#64748b'}}></span>
                    {t?.title || '…'}
                  </span>);
                })()}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Page principale */}
      <div className="min-h-screen w-full bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900">
        <div className="mx-auto max-w-[1400px] px-4 py-4">
          <div className="mb-4 flex items-center justify-between">
            <button onClick={()=>setPanelOpen(true)} className="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-800 shadow-sm hover:bg-slate-50"><span style={{fontSize:18}}>☰</span> Planificateur</button>
            <h1 className="text-lg font-semibold tracking-tight">Planning (sept. 2025 → fév. 2026)</h1>
          </div>

          {categories.length>0 && (
            <div className="mb-4 overflow-x-auto">
              <div className="flex items-center gap-2 whitespace-nowrap">
                {categories.map(c=>(
                  <div key={c.id} className="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-1 text-sm shadow-sm">
                    <input type="checkbox" checked={c.enabled !== false} onChange={()=>toggleCategory(c.id)} className="h-4 w-4 accent-slate-900" />
                    <label className="relative" title={c.color}>
                      <input type="color" value={c.color} onChange={(e)=>updateCategoryColor(c.id, e.target.value)} className="absolute inset-0 h-3 w-3 opacity-0 cursor-pointer" />
                      <span className="inline-block h-3 w-3 rounded-full" style={{backgroundColor:c.color}} />
                    </label>
                    <span className="font-medium">{c.name}</span>
                    <span className="text-xs text-slate-500">{c.color}</span>
                    <button type="button" onClick={(e)=>{e.stopPropagation(); removeCategory(c.id);}} className="ml-1 rounded border border-red-200 bg-white px-1 text-[10px] text-red-700 hover:bg-red-50">🗑</button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Carte agenda */}
          <div className="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm h-[82vh] max-h-[82vh] min-h-0">
            <div className="h-full overflow-auto">
              <div style={{ width: totalWidthPx }}>
                {/* En-tête (sticky) */}
                <div className="sticky top-0 z-10 border-b border-slate-200 bg-white/90">
                  <div style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                    {monthSegments.map((m,i)=>(
                      <div key={i} className="flex items-center justify-center border-r border-slate-100 px-2 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600" style={{gridColumn:`span ${m.span} / span ${m.span}`}}>{m.label}</div>
                    ))}
                  </div>
                  <div className="border-t border-slate-100" style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                    {weeks.map((w,i)=>(
                      <div key={i} className="flex items-center justify-center border-r border-slate-100 px-1 py-1 text-[10px] text-slate-500" title={`${fmtDM.format(w)} → ${fmtDM.format(new Date(w.getTime()+MS_DAY*6))}`}>
                        S{String(getISOWeek(w)).padStart(2,'0')}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Corps */}
                {Array.from({length: Math.max(1, ...tasksToShow.map(t=>+t.row||0))+1}, (_,row)=>row).map(row=>(
                  <div key={row} className="relative border-b border-slate-100" style={{height:ROW_H}}>
                    {/* fond grille */}
                    <div style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`, height:'100%'}}>
                      {weeks.map((_,i)=><div key={i} className={(i%2===0?"border-slate-50":"border-slate-100")+" border-r"} />)}
                    </div>

                    {/* barres */}
                    {tasksToShow.filter(t=> (t.row??0)===row).map(t=>{
                      const {startIdx,span}=taskToGrid(t);
                      const leftPx=startIdx*colWidthPx; const widthPx=span*colWidthPx;
                      const isDragging = drag && drag.taskId===t.id;
                      let leftAdj=leftPx, widthAdj=widthPx, topAdj=ROW_GAP/2;
                      if(isDragging){
                        if(drag.type==='move'){ leftAdj=leftPx+(drag.dx||0); topAdj=ROW_GAP/2+(drag.dy||0); }
                        if(drag.type==='right'){ widthAdj=Math.max(colWidthPx, widthPx+(drag.dx||0)); }
                        if(drag.type==='left'){ const w=Math.max(colWidthPx, widthPx-(drag.dx||0)); leftAdj=leftPx+(drag.dx||0); widthAdj=w; }
                      }
                      const isChild = !!t.parentId;
                      const isNarrow = widthAdj<64;

                      return (
                        <div key={t.id} className="absolute inset-x-0" style={{top:0,height:ROW_H}}>
                          <div
                            className={"group absolute select-none rounded-lg shadow-sm "+(isChild?"":"cursor-pointer")}
                            onClick={()=>!isChild && openSubEditor(t.id)}
                            style={{left:leftAdj,width:widthAdj, top:topAdj, height:ROW_H-ROW_GAP, backgroundColor:t.color}}
                            title={!isChild ? "Cliquer pour ouvrir la sous-frise" : ""}
                          >
                            {/* contenu */}
                            <div className={"flex h-full items-center gap-1 "+(isChild?'pl-4':'pl-1')+" pr-2 text-[11px] text-slate-700"}>
                              {!isNarrow && <span className="inline-block h-2 w-2 rounded" style={{backgroundColor:t.color}}/>}
                              <span className="truncate min-w-0 font-medium" title={`${t.title} — ${t.startISO} → ${t.endISO}`}>{t.title}</span>
                              {!isChild && (
                                <div className="ml-auto hidden items-center gap-1 group-hover:flex">
                                  <button onClick={(e)=>{e.stopPropagation(); changeRow(t.id,-1);}} className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" title="Monter">↑</button>
                                  <button onClick={(e)=>{e.stopPropagation(); changeRow(t.id,+1);}} className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" title="Descendre">↓</button>
                                  <button onClick={(e)=>{e.stopPropagation(); toggleExpanded(t.id);}} className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" title={t.expanded?"Masquer sous-tâches":"Afficher sous-tâches"}>{t.expanded?"–":"+"}</button>
                                  <button onClick={(e)=>{e.stopPropagation(); removeTask(t.id);}} className="rounded border border-red-200 bg-white px-1 text-[10px] text-red-700 hover:bg-red-50" title="Supprimer">🗑</button>
                                </div>
                              )}
                            </div>

                            {/* zones drag resize/déplacement */}
                            {!isChild && (
                              <>
                                <div onPointerDown={(e)=>{e.stopPropagation(); setDrag({taskId:t.id,type:'move',startX:e.clientX,startY:e.clientY,dx:0,dy:0});}} className="absolute inset-y-0 left-2 w-8 cursor-grab" title="Déplacer"></div>
                                <div onPointerDown={(e)=>{e.stopPropagation(); setDrag({taskId:t.id,type:'left',startX:e.clientX,dx:0});}} className="absolute inset-y-0 left-0 w-2 cursor-w-resize" title="Ajuster début"></div>
                                <div onPointerDown={(e)=>{e.stopPropagation(); setDrag({taskId:t.id,type:'right',startX:e.clientX,dx:0});}} className="absolute inset-y-0 right-0 w-2 cursor-e-resize" title="Ajuster fin"></div>
                              </>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            </div>
          </div>
          {/* /carte */}
        </div>
      </div>
    </ErrorBoundary>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<PlannerApp />);
    </script>
  </body>
</html>
```
