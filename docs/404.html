<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning (sept. 2025 ‚Üí f√©v. 2026)</title>
    <!-- Tailwind CDN (prototypage sans build) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + Babel (transpile JSX dans le navigateur) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <meta name="color-scheme" content="light" />
    <style>
      html{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <!-- Point de montage o√π l'application React sera rendue -->
    <!-- Supabase JS v2 (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- App React -->
    <script type="text/babel" data-presets="env,react">
/* ==== App React ==== */
// R√©cup√®re les hooks React utilis√©s dans l'application
const { useEffect, useMemo, useState } = React;

/* Supabase */
// Param√®tres de connexion au projet Supabase
const SUPABASE_URL = "https://kadoikpkjmkchabvnuqs.supabase.co";
// Cl√© publique permettant l'acc√®s anonyme √† l'API
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthZG9pa3Bram1rY2hhYnZudXFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzEwNDIsImV4cCI6MjA3MDkwNzA0Mn0.q28StZ8nsrbck2Xx6xBCfpgdfLotxne3cyWc6-o_FZM";
// Identifiant du document √† charger/enregistrer c√¥t√© base
const DOC_SLUG = "main";
// Client Supabase utilis√© pour toutes les requ√™tes
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Dates / utilitaires */
// Jour de d√©but de semaine (1 = lundi)
const WEEK_STARTS_ON = 1;
// Nombre de millisecondes dans une journ√©e
const MS_DAY = 24 * 60 * 60 * 1000;
// ---- hauteur des lignes (r√©glage unique) ----
const ROW_H   = 26;   // hauteur d‚Äôune ligne en px (essayez 24‚Äì28)
const ROW_GAP = 2;    // petite marge interne pour que la barre ne colle pas au bord
// Retourne le premier jour de la semaine pour une date donn√©e
function startOfWeek(d, w = WEEK_STARTS_ON){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=x.getDay(); const diff=(day-w+7)%7; x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; }
// Retourne le dernier instant de la semaine pour une date donn√©e
function endOfWeek(d, w = WEEK_STARTS_ON){ const s=startOfWeek(d,w); const e=new Date(s.getTime()+MS_DAY*6); e.setHours(23,59,59,999); return e; }
// Force une date √† rester dans un intervalle donn√©
function clampDate(d,minD,maxD){ if(d<minD) return new Date(minD); if(d>maxD) return new Date(maxD); return d; }
// Convertit un objet Date en cha√Æne ISO (YYYY-MM-DD)
function toISODate(d){ const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${yyyy}-${mm}-${dd}`; }
// Ajoute n semaines √† une date ISO tout en respectant des bornes min/max
function addWeeksISO(iso,n,minD,maxD){ const d=new Date(iso); d.setDate(d.getDate()+7*n); return toISODate(clampDate(d,minD,maxD)); }
const fmtMonthYear = new Intl.DateTimeFormat("fr-FR",{month:"long",year:"numeric"});
const fmtDM = new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short"});
// Calcule le num√©ro de semaine ISO pour une date donn√©e
function getISOWeek(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil(((d-yearStart)/MS_DAY+1)/7); }

// Limites de la frise chronologique (arrondies √† des semaines compl√®tes)
const TIMELINE_START = startOfWeek(new Date(2025, 8, 1));
const TIMELINE_END   = endOfWeek(new Date(2026, 1, 28)); /* <-- bug corrig√© (plus de "one:") */

 // Renvoie la liste des d√©buts de semaines entre deux dates incluses
 function eachWeekOfInterval(start,end){
   const weeks=[]; let cur=startOfWeek(start); const endW=startOfWeek(end);
   while(cur<=endW){ weeks.push(new Date(cur)); const next=new Date(cur); next.setDate(next.getDate()+7); cur=startOfWeek(next); if(weeks.length>400) break; }
   return weeks;
 }

/* Cache local */
// Cl√© de stockage local pour persister l'√©tat
const LS_KEY = "gantt-sept2025-fev2026";
// R√©cup√®re l'√©tat sauvegard√© depuis le localStorage
function loadState(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null; }catch{ return null; } }
// Enregistre l'√©tat actuel dans le localStorage
function saveState(state){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{} }

/* Transfert via URL (#s=base64) */
// Encodage/decodage base64 pour le transfert d'√©tat via l'URL
function b64Encode(str){ try{ return btoa(unescape(encodeURIComponent(str))); }catch{ return btoa(str);} }
function b64Decode(str){ try{ return decodeURIComponent(escape(atob(str))); }catch{ return atob(str);} }
// Permet d'importer un √©tat depuis le hash de l'URL (#s=base64)
(function importFromHash(){
  try{
    const h=location.hash;
    if(h && h.startsWith("#s=")){
      const s=JSON.parse(b64Decode(h.slice(3)));
      if(s) localStorage.setItem(LS_KEY, JSON.stringify({categories:s.categories||[],tasks:s.tasks||[]}));
      history.replaceState(null,"", location.pathname+location.search);
    }
  }catch(e){ console.warn("State-from-hash failed",e); }
})();

// Composant React interceptant les erreurs de rendu
class ErrorBoundary extends React.Component{
  constructor(p){ super(p); this.state={error:null}; }
  static getDerivedStateFromError(e){ return {error:e}; }
  render(){
    if(this.state.error){
      return <div style={{padding:16}} className="mx-auto max-w-[900px] rounded-xl border border-red-200 bg-red-50 text-red-800">
        <div className="font-semibold">Une erreur est survenue.</div>
        <div className="text-sm mt-1">{String(this.state.error?.message || this.state.error)}</div>
      </div>;
    }
    return this.props.children;
  }
}

// Palette de couleurs propos√©e pour les cat√©gories et t√¢ches
const PALETTE=["#2563eb","#16a34a","#ea580c","#9333ea","#0ea5e9","#ef4444","#22c55e","#f59e0b","#64748b","#d946ef","#14b8a6","#a16207"];

// Composant principal du planificateur
function PlannerApp(){
  // Tableau des semaines affich√©es dans la frise
  const weeks = useMemo(()=>eachWeekOfInterval(TIMELINE_START,TIMELINE_END),[]);
  // D√©coupe des semaines par mois pour l'en-t√™te
  const monthSegments = useMemo(()=>{
    if(weeks.length===0) return [];
    const segs=[]; let currentLabel=fmtMonthYear.format(new Date(weeks[0].getTime()+MS_DAY*3)); let span=0;
    for(let i=0;i<weeks.length;i++){ const label=fmtMonthYear.format(new Date(weeks[i].getTime()+MS_DAY*3)); if(label===currentLabel) span++; else { segs.push({label:currentLabel,span}); currentLabel=label; span=1; } }
    segs.push({label:currentLabel,span}); return segs;
  },[weeks]);

  // √âtat initial issu du cache local
  const initial = loadState();
  // Liste des cat√©gories affich√©es
  const [categories,setCategories] = useState(initial?.categories || []);
  // Liste des t√¢ches planifi√©es
  const [tasks,setTasks] = useState((initial?.tasks || []).map((t,i)=>({
    ...t,
    row: typeof t.row === 'number' ? t.row : i,
    subtasks: Array.isArray(t.subtasks) ? t.subtasks : [],
    expanded: !!t.expanded
  })));
  // Informations de synchronisation avec Supabase
  const [sync,setSync] = useState({status:'idle',ts:null,error:null});
  // Affichage des outils de test
  const [showTests,setShowTests]=useState(false);
  // Ouverture du panneau lat√©ral
  const [panelOpen,setPanelOpen]=useState(false);

  /* Charger depuis Supabase */
  useEffect(()=>{
    (async ()=>{
      setSync({status:'loading',ts:null,error:null});
      console.log("[Supabase] fetching state for slug:", DOC_SLUG);
      const { data, error } = await supabase
        .from("planner_state")
        .select("data")
        .eq("slug", DOC_SLUG)
        .maybeSingle();

      if(error){
        console.error("[Supabase] select error:", error);
        setSync({status:'error',ts:null,error:error.message});
        return; /* on garde l‚Äô√©tat local */
      }
      if(data?.data){
        console.log("[Supabase] state loaded.");
        const s=data.data;
        setCategories(Array.isArray(s.categories)? s.categories:[]);
        setTasks(Array.isArray(s.tasks)? s.tasks.map((t,i)=>({
          ...t,
          row: typeof t.row === 'number' ? t.row : i,
          subtasks: Array.isArray(t.subtasks) ? t.subtasks : [],
          expanded: !!t.expanded
        })) : []);
        setSync({status:'ok',ts:new Date().toISOString(),error:null});
      }else{
        console.log("[Supabase] no row yet; inserting current local state.");
        await supabase.from("planner_state").insert({slug:DOC_SLUG,data:{categories,tasks},updated_at:new Date().toISOString()});
        setSync({status:'ok',ts:new Date().toISOString(),error:null});
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  },[]);

  /* Cache local */
  useEffect(()=>{ saveState({categories,tasks}); },[categories,tasks]);

  /* Sauvegarde Supabase (debounce) */
  useEffect(()=>{
    const payload={categories,tasks};
    const t=setTimeout(async ()=>{
      setSync(s=>({...s,status:'saving'}));
      const { error } = await supabase
        .from("planner_state")
        .upsert({slug:DOC_SLUG,data:payload,updated_at:new Date().toISOString()});
      if(error){ console.error("[Supabase] upsert error:", error); setSync({status:'error',ts:null,error:error.message}); }
      else { setSync({status:'ok',ts:new Date().toISOString(),error:null}); }
    },600);
    return ()=>clearTimeout(t);
  },[categories,tasks]);

  useEffect(()=>{
    function onKey(e){ if(e.key==='Escape') setPanelOpen(false); }
    if(panelOpen) window.addEventListener('keydown',onKey);
    return ()=>window.removeEventListener('keydown',onKey);
  },[panelOpen]);

  const [newTask,setNewTask]=useState({ title:"", startISO:toISODate(TIMELINE_START), endISO:toISODate(new Date(TIMELINE_START.getTime()+MS_DAY*7)), range:`${toISODate(TIMELINE_START)} ‚Üí ${toISODate(new Date(TIMELINE_START.getTime()+MS_DAY*7))}`, color:"#2563eb", categoryId:"", newCategoryName:"" });

  function weekIndexOf(date){ const s=startOfWeek(clampDate(date,TIMELINE_START,TIMELINE_END)); const idx=Math.round((s.getTime()-TIMELINE_START.getTime())/(MS_DAY*7)); return Math.max(0,Math.min(weeks.length-1,idx)); }
  function taskToGrid(task){ const start=new Date(task.startISO); const end=new Date(task.endISO); const startIdx=weekIndexOf(start); const endIdx=weekIndexOf(end); const span=Math.max(1,endIdx-startIdx+1); return {startIdx,span}; }
  function parseDateRangeFromText(text){
    if(typeof text!=="string") return null; const raw=text.trim(); if(!raw) return null;
    let sep="‚Üí", idx=raw.indexOf("‚Üí"); if(idx<0){ for(const c of [" ‚Äî "," ‚Äì "," to "," au "," -> "," - "]){ const j=raw.indexOf(c); if(j>=0){ sep=c; idx=j; break; } } }
    if(idx<0) return null; const a=raw.slice(0,idx).trim(); const b=raw.slice(idx+sep.length).trim();
    const isISO=x=>x && x.length===10 && x[4]==='-' && x[7]==='-' && !isNaN(Date.parse(x));
    if(!isISO(a)||!isISO(b)) return null; const s=clampDate(new Date(a),TIMELINE_START,TIMELINE_END); const e=clampDate(new Date(b),TIMELINE_START,TIMELINE_END);
    return { startISO:toISODate(s), endISO:toISODate(e) };
  }
  function getOrCreateCategoryByName(name,colorOverride){
    let c=categories.find(x=>x.name===name); if(c) return c;
    const color=colorOverride || PALETTE[categories.length%PALETTE.length];
    c={ id:`c-${Date.now()}-${Math.random().toString(36).slice(2,6)}`, name, color, enabled:true };
    setCategories(prev=>[...prev,c]); return c;
  }
  function addTask(e){
    e.preventDefault();
    const s=new Date(newTask.startISO), eDate=new Date(newTask.endISO);
    if(s>eDate){ alert("La date de d√©but doit pr√©c√©der la date de fin."); return; }
    let chosenCat=categories.find(c=>c.id===newTask.categoryId);
    if(!chosenCat && newTask.newCategoryName.trim()){
      const existingByName=categories.find(c=>c.name.toLowerCase()===newTask.newCategoryName.trim().toLowerCase());
      if(existingByName) chosenCat=existingByName; else chosenCat=getOrCreateCategoryByName(newTask.newCategoryName.trim(),newTask.color);
    }
    const color=chosenCat?chosenCat.color:newTask.color;
    const t={ id:`t-${Date.now()}`, title:newTask.title || (chosenCat?chosenCat.name:"Sans titre"), startISO:toISODate(clampDate(s,TIMELINE_START,TIMELINE_END)), endISO:toISODate(clampDate(eDate,TIMELINE_START,TIMELINE_END)), color, categoryId:chosenCat?.id, actions:[], sourceLabel:null, row:tasks.length, notes:[], subtasks:[], expanded:false };
    setTasks(prev=>[...prev,t]);
  }
  function removeTask(id){ setTasks(prev=>{ const removed=prev.find(t=>t.id===id); const next=prev.filter(t=>t.id!==id); if(removed?.categoryId){ const stillUsed=next.some(t=>t.categoryId===removed.categoryId); if(!stillUsed) setCategories(cprev=>cprev.filter(c=>c.id!==removed.categoryId)); } return next; }); }
  function removeCategory(id){ if(!categories.find(c=>c.id===id)) return; setTasks(prev=>prev.filter(t=>t.categoryId!==id)); setCategories(prev=>prev.filter(c=>c.id!==id)); }
  function toggleCategory(id){ setCategories(prev=>prev.map(c=> c.id===id ? {...c,enabled:!(c.enabled!==false)} : c)); }
  function updateCategoryColor(id,newColor){ setCategories(prev=>prev.map(c=> c.id===id ? {...c,color:newColor} : c)); setTasks(prev=>prev.map(t=> t.categoryId===id ? {...t,color:newColor} : t)); }
  function resetAll(){ try{ localStorage.removeItem(LS_KEY);}catch{} setPanelOpen(false); setCategories([]); setTasks([]); setNewTask({ title:"", startISO:toISODate(TIMELINE_START), endISO:toISODate(new Date(TIMELINE_START.getTime()+MS_DAY*7)), range:`${toISODate(TIMELINE_START)} ‚Üí ${toISODate(new Date(TIMELINE_START.getTime()+MS_DAY*7))}`, color:"#2563eb", categoryId:"", newCategoryName:""}); }

  const enabledCategoryIds = useMemo(()=> new Set(categories.filter(c=>c.enabled!==false).map(c=>c.id)),[categories]);
  const tasksToShow = useMemo(()=>{
    const filtered = !categories.length ? tasks : tasks.filter(t=>!t.categoryId || enabledCategoryIds.has(t.categoryId));
    const sorted = filtered.slice().sort((a,b)=> (a.row??0) - (b.row??0));
    const result=[];
    let offset=0;
    for(const t of sorted){
      const baseRow=(t.row??0)+offset;
      result.push({...t,row:baseRow});
      if(t.expanded && Array.isArray(t.subtasks)){
        t.subtasks.forEach((st,idx)=>{
          result.push({...st,row:baseRow+idx+1,parentId:t.id});
        });
        offset += t.subtasks.length;
      }
    }
    return result;
  },[tasks,categories,enabledCategoryIds]);

  const colWidthPx = 44;
  const gridCols = `repeat(${weeks.length}, ${colWidthPx}px)`;
  const gridStyle = { display:'grid', gridTemplateColumns:gridCols };

  const [drag,setDrag]=useState(null);
  useEffect(()=>{
    if(!drag) return;
    function onMove(e){ setDrag(d => d ? {...d, dx:e.clientX - d.startX, dy:e.clientY - d.startY} : d); }
    function onUp(){
      setTasks(prev=>{
        const d=drag; if(!d) return prev;
        const idx=prev.findIndex(t=>t.id===d.taskId); if(idx<0) return prev;
        const t=prev[idx]; const { span }=taskToGrid(t); const deltaWeeks=Math.round((d.dx||0)/colWidthPx); const deltaRows=Math.round((d.dy||0)/ROW_H);
        if(deltaWeeks===0 && deltaRows===0) return prev.slice();
        if(d.type==='move'){ const ns=addWeeksISO(t.startISO,deltaWeeks,TIMELINE_START,TIMELINE_END); const ne=addWeeksISO(t.endISO,deltaWeeks,TIMELINE_START,TIMELINE_END); const newRow=Math.max(0,(t.row??0)+deltaRows); const updated={...t,startISO:ns,endISO:ne,row:newRow}; const copy=prev.slice(); copy[idx]=updated; return copy; }
        if(d.type==='right'){ const ne=addWeeksISO(t.endISO,deltaWeeks,TIMELINE_START,TIMELINE_END); const newT=new Date(ne); const sT=startOfWeek(new Date(t.startISO)); const eT=startOfWeek(newT); const newSpan=Math.max(1,Math.round((eT-sT)/(MS_DAY*7))+1); const adjWeeks=newSpan-span; const neAdj=addWeeksISO(t.endISO,adjWeeks,TIMELINE_START,TIMELINE_END); const updated={...t,endISO:neAdj}; const copy=prev.slice(); copy[idx]=updated; return copy; }
        if(d.type==='left'){ let ns=addWeeksISO(t.startISO,deltaWeeks,TIMELINE_START,TIMELINE_END); const sT=startOfWeek(new Date(ns)); const eT=startOfWeek(new Date(t.endISO)); let newSpan=Math.max(1,Math.round((eT-sT)/(MS_DAY*7))+1); if(newSpan<1) newSpan=1; const endIdx=weekIndexOf(new Date(t.endISO)); const startIdxNew=Math.max(0,endIdx-(newSpan-1)); const nsDate=new Date(TIMELINE_START.getTime()+startIdxNew*7*MS_DAY); ns=toISODate(clampDate(nsDate,TIMELINE_START,TIMELINE_END)); const updated={...t,startISO:ns}; const copy=prev.slice(); copy[idx]=updated; return copy; }
        return prev;
      });
      setDrag(null);
    }
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',onUp);
    return ()=>{ window.removeEventListener('pointermove',onMove); window.removeEventListener('pointerup',onUp); };
  },[drag]);

  function changeRow(id,delta){ setTasks(prev=> prev.map(t=> t.id===id ? {...t, row:Math.max(0,(t.row??0)+delta)} : t)); }

  function toggleExpanded(id){ setTasks(prev=> prev.map(t=> t.id===id ? {...t, expanded: !t.expanded} : t)); }

  const [noteEditor,setNoteEditor]=useState({taskId:null,draft:""});
  function openNotes(taskId){ setNoteEditor({taskId,draft:""}); }
  function addNoteToTask(taskId,text){ const v=(text||"").trim(); if(!v) return; setTasks(prev=> prev.map(t=> t.id===taskId ? {...t, notes:[...(t.notes||[]), v]} : t)); setNoteEditor({taskId, draft:""}); }
  function deleteNote(taskId,idx){ setTasks(prev=> prev.map(t=> t.id===taskId ? {...t, notes:(t.notes||[]).filter((_,i)=>i!==idx)} : t)); }

  const testResults = useMemo(()=>{
    const results = [];
    const t1 = TIMELINE_START.getDay()===1 && TIMELINE_START.getDate()===1 && TIMELINE_START.getMonth()===8;
    results.push({ name:"TIMELINE_START est lun 1 sept. 2025", pass:t1, details: toISODate(TIMELINE_START)});
    const weeksCountOk = weeks.length>0 && weeks.length<60;
    results.push({ name:"Nombre de semaines plausible", pass:weeksCountOk, details:String(weeks.length)});
    const sumSpan = monthSegments.reduce((a,b)=>a+b.span,0);
    results.push({ name:"Somme spans == nb semaines", pass: sumSpan===weeks.length, details: `${sumSpan} vs ${weeks.length}`});
    const allEnabledByDefault = categories.every(c=> c.enabled !== false);
    results.push({ name:"Cat√©gories actives par d√©faut", pass: allEnabledByDefault, details: String(allEnabledByDefault)});
    const w0 = weekIndexOf(TIMELINE_START)===0;
    results.push({ name:"weekIndexOf(TIMELINE_START) == 0", pass:w0, details:String(w0)});
    const spanOk = tasks.every(t=> { const g = taskToGrid(t); return g && g.span>=1; });
    results.push({ name:"Span ‚â• 1 pour toutes les t√¢ches", pass: spanOk, details: String(spanOk)});
    const noDupIso = weeks.every((w,i,a)=> i===0 || getISOWeek(w) !== getISOWeek(a[i-1]));
    results.push({ name:"Semaines ISO sans doublon cons√©cutif", pass: noDupIso, details: String(noDupIso) });
    const hasDangling = (()=>{ const catIds = new Set(categories.map(c=>c.id)); return tasks.some(t=> t.categoryId && !catIds.has(t.categoryId)); })();
    results.push({ name:"Pas de r√©f√©rence de cat√©gorie orpheline", pass: !hasDangling, details: String(!hasDangling)});
    results.push({ name:"resetAll() est une fonction", pass: typeof resetAll === 'function', details: typeof resetAll });
    const hexOk = categories.every(c=> /^#[0-9A-Fa-f]{3}([0-9A-Fa-f]{3})?$/.test(String(c.color || "")));
    results.push({ name:"Couleurs cat√©gories au format hex", pass: hexOk, details: String(hexOk)});
    const showCountOk = tasksToShow.filter(t=>!t.parentId).length <= tasks.length;
    results.push({ name:"Filtre ‚â§ total", pass: showCountOk, details: `${tasksToShow.filter(t=>!t.parentId).length}/${tasks.length}`});
    const taskColorsOk = tasks.every(t=> /^#[0-9A-Fa-f]{3}([0-9A-Fa-f]{3})?$/.test(String(t.color || "")));
    results.push({ name:"Couleurs t√¢ches au format hex", pass: taskColorsOk, details: String(taskColorsOk) });
    const catColorMap = new Map(categories.map(c=>[c.id,c.color]));
    const syncOk = tasks.every(t=> !t.categoryId || t.color === catColorMap.get(t.categoryId));
    results.push({ name:"T√¢ches sync avec couleur cat√©gorie", pass: syncOk, details: String(syncOk) });
    const colsOk = weeks.length>0 && typeof gridCols === 'string';
    results.push({ name:"Grille OK", pass: colsOk, details: gridCols});
    const p = parseDateRangeFromText("2025-09-06 ‚Üí 2025-09-22");
    const parseOk = !!p && p.startISO === "2025-09-06" && p.endISO === "2025-09-22";
    results.push({ name:"Parse plage date", pass: parseOk, details: p ? `${p.startISO}‚Üí${p.endISO}` : "null"});
    const notesArrOk = tasks.every(t=> Array.isArray(t.notes || []));
    results.push({ name:"Notes: tableau pr√©sent", pass: notesArrOk, details: String(notesArrOk)});
    const subtasksArrOk = tasks.every(t=> Array.isArray(t.subtasks || []));
    results.push({ name:"Sous-t√¢ches: tableau pr√©sent", pass: subtasksArrOk, details: String(subtasksArrOk)});
    const expandedBoolOk = tasks.every(t=> typeof t.expanded === 'boolean');
    results.push({ name:"expanded est bool√©en", pass: expandedBoolOk, details: String(expandedBoolOk)});
    return results;
  },[weeks.length, monthSegments, categories, tasks, tasksToShow.length, gridCols]);

  /* UI */
  return (
    <ErrorBoundary>
      {panelOpen && (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/20" onClick={()=>setPanelOpen(false)} />
          <aside className="absolute left-0 top-0 h-full w-[380px] max-w-[90vw] overflow-y-auto border-r border-slate-200 bg-white shadow-xl" onClick={e=>e.stopPropagation()}>
            <div className="sticky top-0 z-10 flex items-center justify-between border-b border-slate-200 bg-white px-4 py-3">
              <div className="font-medium">Planificateur</div>
              <div className="flex items-center gap-2">
                <button onClick={()=>setShowTests(v=>!v)} className="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50">{showTests ? 'Tests: ON' : 'Tests: OFF'}</button>
                <button onClick={()=>setPanelOpen(false)} className="rounded-full border border-slate-300 bg-white px-2 py-1 text-sm text-slate-700 hover:bg-slate-50" aria-label="Fermer">‚úï</button>
              </div>
            </div>
            <div className="p-4 space-y-4">
              <div className="flex flex-col gap-2">
                <button onClick={resetAll} className="inline-flex items-center gap-2 rounded-lg border border-red-300 bg-white px-3 py-2 text-sm font-medium text-red-700 shadow-sm hover:bg-red-50">R√©initialiser tout</button>
                <span className="text-xs rounded-full border px-2 py-1" style={{borderColor:'#cbd5e1', color: sync.status==='error' ? '#b91c1c' : '#334155', backgroundColor: sync.status==='saving' ? '#f1f5f9' : '#fff' }}>
                  {sync.status==='loading' && 'Synchro‚Ä¶'}
                  {sync.status==='saving'  && 'Enregistrement‚Ä¶'}
                  {sync.status==='ok'      && (sync.ts ? `Synchro OK ¬∑ ${new Date(sync.ts).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}` : 'Synchro OK')}
                  {sync.status==='error'   && 'Erreur de synchro'}
                </span>
                <button onClick={()=>{ const data=JSON.stringify({categories,tasks}); navigator.clipboard.writeText(data).then(()=>alert('√âtat copi√©.')).catch(()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download='planner-state.json'; a.click(); }); setPanelOpen(false); }} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">Exporter</button>
                <button onClick={()=>{ const t=prompt('Collez le JSON :'); if(!t) return; try{ const s=JSON.parse(t); setCategories(Array.isArray(s.categories)?s.categories:[]); setTasks(Array.isArray(s.tasks)? s.tasks.map((t,i)=>({
                  ...t,
                  row: typeof t.row === 'number' ? t.row : i,
                  subtasks: Array.isArray(t.subtasks) ? t.subtasks : [],
                  expanded: !!t.expanded
                })) : []);}catch{ alert('JSON invalide'); } setPanelOpen(false); }} className="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">Importer</button>
                <button onClick={()=>{ const url=location.origin+location.pathname+location.search+'#s='+b64Encode(JSON.stringify({categories,tasks})); window.open(url,'_blank'); setPanelOpen(false); }} className="rounded-lg bg-slate-900 px-3 py-2 text-sm font-medium text-white hover:bg-slate-800">Nouveau (‚Üí transf√®re)</button>
              </div>
              <form onSubmit={addTask} className="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                <h2 className="mb-2 text-sm font-medium text-slate-700">Ajouter une ligne (t√¢che)</h2>
                <div className="grid grid-cols-1 gap-3">
                  <label className="text-sm">Intitul√©
                    <input type="text" value={newTask.title} onChange={(e)=>setNewTask(s=>({...s,title:e.target.value}))} placeholder="Ex. Semaine de tournage" className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
                  </label>
                  <label className="text-sm">Plage de dates
                    <input type="text" value={newTask.range} onChange={(e)=>{ const v=e.target.value; setNewTask(s=>{ const p=parseDateRangeFromText(v); return p ? {...s,range:v,startISO:p.startISO,endISO:p.endISO} : {...s,range:v}; }); }} placeholder="2025-09-06 ‚Üí 2025-09-22" className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
                  </label>
                  <div className="grid grid-cols-2 gap-3">
                    <label className="text-sm">Cat√©gorie (couleur + nom)
                      <select value={newTask.categoryId} onChange={(e)=>setNewTask(s=>({...s,categoryId:e.target.value}))} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400">
                        <option value="">‚Äî Aucune ‚Äî</option>
                        {categories.map(c=>(<option key={c.id} value={c.id}>{c.name}</option>))}
                      </select>
                    </label>
                    <label className="text-sm">Couleur (si pas de cat√©gorie)
                      <input type="color" value={newTask.color} onChange={(e)=>setNewTask(s=>({...s,color:e.target.value}))} className="mt-1 h-10 w-full cursor-pointer rounded-lg border border-slate-300" title="Choisir une couleur" />
                    </label>
                  </div>
                  <label className="text-sm">D√©nomination (si nouvelle couleur)
                    <input type="text" value={newTask.newCategoryName} onChange={(e)=>setNewTask(s=>({...s,newCategoryName:e.target.value}))} placeholder="Ex. Montage" className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
                  </label>
                  <button type="submit" className="mt-1 inline-flex items-center justify-center rounded-xl bg-slate-900 px-3 py-2 text-sm font-medium text-white hover:bg-slate-800">Ajouter la ligne</button>
                </div>
              </form>
              {showTests && (
                <div className="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                  <h2 className="mb-2 text-sm font-medium text-slate-700">Tests</h2>
                  <ul className="space-y-1 text-sm">
                    {testResults.map((t,i)=>(
                      <li key={i} className="flex items-center gap-3">
                        <span className={(t.pass?"bg-green-100 text-green-700":"bg-red-100 text-red-700")+" inline-flex h-5 min-w-[20px] items-center justify-center rounded px-1 text-xs font-semibold"}>{t.pass?"OK":"KO"}</span>
                        <span>{t.name}</span>
                        <span className="ml-auto text-xs text-slate-500">{t.details}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </aside>
        </div>
      )}
      <div className="min-h-screen w-full bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900">
        <div className="mx-auto max-w-[1400px] px-4 py-4">
          <div className="mb-4 flex items-center justify-between">
            <button onClick={()=>setPanelOpen(true)} className="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-800 shadow-sm hover:bg-slate-50"><span style={{fontSize:18}}>‚ò∞</span> Planificateur</button>
            <h1 className="text-lg font-semibold tracking-tight">Planning (sept. 2025 ‚Üí f√©v. 2026)</h1>
          </div>

          {categories.length>0 && (
            <div className="mb-4 overflow-x-auto">
              <div className="flex items-center gap-2 whitespace-nowrap">
                {categories.map(c=>(
                  <div key={c.id} className="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-1 text-sm shadow-sm">
                    <input type="checkbox" checked={c.enabled !== false} onChange={()=>toggleCategory(c.id)} className="h-4 w-4 accent-slate-900" />
                    <label className="relative" title={c.color}>
                      <input type="color" value={c.color} onChange={(e)=>updateCategoryColor(c.id, e.target.value)} className="absolute inset-0 h-3 w-3 opacity-0 cursor-pointer" />
                      <span className="inline-block h-3 w-3 rounded-full" style={{backgroundColor:c.color}} />
                    </label>
                    <span className="font-medium">{c.name}</span>
                    <span className="text-xs text-slate-500">{c.color}</span>
                    <button type="button" onClick={(e)=>{e.stopPropagation(); removeCategory(c.id);}} className="ml-1 rounded border border-red-200 bg-white px-1 text-[10px] text-red-700 hover:bg-red-50">üóë</button>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm h-[82vh] max-h-[82vh] flex flex-col min-h-0">
            {/* En-t√™te */}
            <div className="sticky top-0 z-10 border-b border-slate-200 bg-white/90">
              <div style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                {monthSegments.map((m,i)=>(
                  <div key={`${m.label}-${i}`} className="flex items-center justify-center border-r border-slate-100 px-2 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600" style={{gridColumn:`span ${m.span} / span ${m.span}`}}>{m.label}</div>
                ))}
              </div>
              <div className="border-t border-slate-100" style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                {weeks.map((w,i)=>(
                  <div key={i} className="flex items-center justify-center border-r border-slate-100 px-1 py-1 text-[10px] text-slate-500" title={`${fmtDM.format(w)} ‚Üí ${fmtDM.format(new Date(w.getTime()+MS_DAY*6))}`}>
                    S{String(getISOWeek(w)).padStart(2,'0')}
                  </div>
                ))}
              </div>
            </div>

            {/* Corps */}
            <div className="min-h-0 flex-1 overflow-auto" style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
              {Array.from({length: Math.max(0,...tasksToShow.map(t=>typeof t.row==='number'?t.row:0))+1}, (_,row)=>row).map(row=>(
                <div key={row} className="relative border-b border-slate-100" style={{gridColumn:`1 / -1`}}>
                  <div style={{display:'grid', gridTemplateColumns:`repeat(${weeks.length}, ${colWidthPx}px)`}}>
                    {weeks.map((_,i)=>(
                      <div
                        key={i}
                        className={(i%2===0?"border-slate-50":"border-slate-100")+" border-r"}
                        style={{ height: ROW_H }}
                      />
                    ))}
                  </div>
                  {tasksToShow.filter(t=>(t.row??0)===row).map(t=>{
                    const {startIdx,span}=taskToGrid(t);
                    const leftPx=startIdx*colWidthPx; const widthPx=span*colWidthPx;
                    const isDragging=drag && drag.taskId===t.id;
                    let leftAdj=leftPx, widthAdj=widthPx, topAdj=ROW_GAP/2;
                    if(isDragging){ if(drag.type==='move'){ leftAdj=leftPx+(drag.dx||0); topAdj=ROW_GAP/2+(drag.dy||0); } if(drag.type==='right') widthAdj=Math.max(colWidthPx,widthPx+(drag.dx||0)); if(drag.type==='left'){ const w=Math.max(colWidthPx,widthPx-(drag.dx||0)); leftAdj=leftPx+(drag.dx||0); widthAdj=w; } }
                    const isSub = !!t.parentId;
                    const isNarrow=widthAdj<64; const noteCount=Array.isArray(t.notes)?t.notes.length:0;
                    const charWidth=0.6;
                    const fontPx=Math.min(11, Math.max(8, Math.floor(widthAdj/(charWidth*Math.max(1, t.title.length)))));
                    return (
                      <div key={t.id} className="pointer-events-none absolute left-0 top-0 w-full" style={{ height: ROW_H }}>
                        <div
                          className="pointer-events-auto absolute select-none rounded-lg shadow-sm group"
                          onDoubleClick={()=>toggleExpanded(t.parentId || t.id)}
                          style={{
                            left: leftAdj,
                            width: widthAdj,
                            top: topAdj,
                            height: ROW_H - ROW_GAP,
                            backgroundColor: t.color
                          }}
                        >
                          {noteCount>0 && !isSub && <span className="absolute -top-1 -left-1 inline-flex h-4 min-w-[16px] items-center justify-center rounded-full border border-white bg-slate-900 px-1 text-[10px] font-semibold text-white">{noteCount}</span>}
                          <div className={`flex h-full items-center gap-1 ${isSub? 'pl-4':'pl-1'} pr-2 text-slate-700`} style={{fontSize:fontPx}}>
                            {!isNarrow && <span className="inline-block h-2 w-2 rounded" style={{backgroundColor:t.color}}/>}
                            <span className="min-w-0 font-medium whitespace-nowrap" title={`${t.title} ‚Äî ${t.startISO} ‚Üí ${t.endISO}`}>{t.title}</span>
                            {!isSub && <div className="ml-auto hidden items-center gap-1 group-hover:flex">
                              <button onClick={()=>openNotes(t.id)} className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" title="Notes">üí¨</button>
                              <button onClick={()=>removeTask(t.id)} className="rounded border border-red-200 bg-white px-1 text-[10px] text-red-700 hover:bg-red-50" title="Supprimer">üóë</button>
                            </div>}
                          </div>
                          {!isSub && <div onPointerDown={(e)=>setDrag({taskId:t.id,type:'move',startX:e.clientX,startY:e.clientY,dx:0,dy:0})} className="absolute inset-y-0 left-2 w-8 cursor-grab" title="D√©placer" />}
                          {!isSub && <div onPointerDown={(e)=>setDrag({taskId:t.id,type:'left',startX:e.clientX,startY:e.clientY,dx:0,dy:0})}  className="absolute inset-y-0 left-0 w-2 cursor-w-resize" title="Ajuster d√©but" />}
                          {!isSub && <div onPointerDown={(e)=>setDrag({taskId:t.id,type:'right',startX:e.clientX,startY:e.clientY,dx:0,dy:0})} className="absolute inset-y-0 right-0 w-2 cursor-e-resize" title="Ajuster fin" />}
                          {noteEditor.taskId===t.id && !isSub && (
                            <div className="absolute right-0 top-[110%] z-20 w-[280px] rounded-xl border border-slate-200 bg-white p-3 text-[12px] shadow-lg">
                              <div className="mb-2 flex items-center justify-between"><div className="font-medium">Notes</div><button className="rounded border border-slate-300 bg-white px-1 text-[10px] hover:bg-slate-50" onClick={()=>setNoteEditor({taskId:null,draft:""})}>‚úï</button></div>
                              <div className="max-h-40 space-y-2 overflow-y-auto">
                                {(t.notes||[]).length===0 && <div className="text-slate-500">Aucune note</div>}
                                {(t.notes||[]).map((n,idx)=>(
                                  <div key={idx} className="flex items-start gap-2">
                                    <div className="mt-[2px]">‚Ä¢</div>
                                    <div className="min-w-0 flex-1 break-words">{n}</div>
                                    <button className="rounded border border-red-200 bg-white px-1 text-[10px] text-red-700 hover:bg-red-50" onClick={()=>deleteNote(t.id,idx)}>üóë</button>
                                  </div>
                                ))}
                              </div>
                              <div className="mt-2 flex items-center gap-2">
                                <input value={noteEditor.draft} onChange={(e)=>setNoteEditor(s=>({...s,draft:e.target.value}))} placeholder="Ajouter une note" className="flex-1 rounded-lg border border-slate-300 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-slate-400" />
                                <button className="rounded-lg bg-slate-900 px-2 py-1 text-xs font-medium text-white hover:bg-slate-800" onClick={()=>addNoteToTask(t.id,noteEditor.draft)}>Ajouter</button>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </ErrorBoundary>
  );
}

// Monte l'application React dans la page
ReactDOM.createRoot(document.getElementById('root')).render(<PlannerApp />);
    </script>
  </body>
</html>
